// First, let's resolve the merge conflicts and organize the code
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Infinite Survivor Game â€“ Phaser Edition</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mocha/mocha.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chai/chai.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mocha/mocha.css" />
  <style>
    body { margin: 0; background: #111; }
    #gameContainer { position: relative; }
    canvas { display: block; }
    .overlay {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      display: none; 
      justify-content: center;
      align-items: center;
      flex-direction: column;
      font-family: Arial, sans-serif;
      color: white;
      z-index: 10;
    }
    .button {
      margin: 10px;
      padding: 10px 20px;
      background: #444;
      border: none;
      color: white;
      cursor: pointer;
    }
    .button:hover { background: #666; }
    #gameControls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 20;
    }
    #hud {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 30;
      color: white;
      font-family: Arial, sans-serif;
    }
    #debugOverlay {
      position: absolute;
      bottom: 0;
      left: 0;
      background: rgba(0,0,0,0.7);
      color: #0f0;
      padding: 5px;
      font-family: monospace;
      font-size: 12px;
      z-index: 40;
      display: none;
    }
    #mocha { padding: 20px; }
  </style>
</head>
<body>
<div id="gameContainer">
  <div id="gameControls">
    <button class="button" onclick="restartGame()">Restart</button>
    <button class="button" onclick="saveGame()">Save Game</button>
    <button class="button" onclick="loadGame()">Load Game</button>
    <button class="button" onclick="openShop()">Shop</button>
    <button class="button" onclick="openSettings()">Settings</button>
    <button class="button" onclick="openBestiary()">Bestiary</button>
    <button class="button" onclick="toggleDebug()">Toggle Debug</button>
    <button class="button" onclick="runTests()">Run Tests</button>
  </div>
  <div id="hud"></div>
  <div id="debugOverlay"></div>
  
  <!-- Upgrade Overlay -->
  <div id="upgradeOverlay" class="overlay">
    <h1>Level Up!</h1>
    <h2>Upgrades</h2>
    <button class="button" onclick="chooseUpgrade('damage')">Increase Blaster Damage (+10%)</button>
    <button class="button" onclick="chooseUpgrade('player')">Increase Player Speed (+5%)</button>
    <button class="button" onclick="chooseUpgrade('attack')">Upgrade MultiShot (+1 Ball)</button>
    <h2>Accessories</h2>
    <button class="button" onclick="chooseUpgrade('accessory')">Accessory Upgrade (Add Blaster Functionality)</button>
  </div>

  <!-- Shop Overlay -->
  <div id="shopOverlay" class="overlay">
    <h1>Shop</h1>
    <p>Persistent Coins: <span id="coinCount">0</span></p>
    <button class="button" onclick="buyItem('maxHealth')">Increase Max Health (+20) - 10 coins</button>
    <button class="button" onclick="buyItem('speed')">Increase Speed (+1) - 15 coins</button>
    <button class="button" onclick="buyItem('damage')">Increase Damage (+2) - 20 coins</button>
    <button class="button" onclick="buyItem('xpSuck')">Increase XP Suck Range (+20) - 10 coins</button>
    <button class="button" onclick="buyItem('coinSuck')">Increase Coin Suck Range (+20) - 10 coins</button>
    <button class="button" onclick="buyItem('restore')">Restore Health - 5 coins</button>
    <button class="button" onclick="closeShop()">Close Shop</button>
  </div>

  <!-- Settings Overlay -->
  <div id="settingsOverlay" class="overlay">
    <h1>Settings</h1>
    <p>Customize game values:</p>
    <div><label>Player Base Speed: </label><input type="number" id="inpPlayerSpeed" value="100"></div>
    <div><label>Bullet Speed: </label><input type="number" id="inpBulletSpeed" value="100"></div>
    <div><label>Enemy Speed: </label><input type="number" id="inpEnemySpeed" value="60"></div>
    <div><label>XP Suck Range: </label><input type="number" id="inpXpSuck" value="100"></div>
    <div><label>Coin Suck Range: </label><input type="number" id="inpCoinSuck" value="150"></div>
    <div><label>Fire Interval (ms): </label><input type="number" id="inpFireInterval" value="1500"></div>
    <div><label>Player Attack Damage: </label><input type="number" id="inpAttackDamage" value="10"></div>
    <div><label>Projectile Lifetime (ms): </label><input type="number" id="inpProjLifetime" value="4000"></div>
    <button class="button" onclick="saveSettings()">Save Settings</button>
    <button class="button" onclick="closeSettings()">Close Settings</button>
  </div>

  <!-- Bestiary Overlay -->
  <div id="bestiaryOverlay" class="overlay">
    <h1>Bestiary</h1>
    <p>Enemy Types:</p>
    <ul>
      <li><strong>Basic:</strong> Low health, standard speed, does not shoot.</li>
      <li><strong>Fast:</strong> Lower health, higher speed.</li>
      <li><strong>Shooter:</strong> Moderate health, shoots two projectiles.</li>
      <li><strong>Bomber:</strong> High health, drops bombs that explode with area damage.</li>
    </ul>
    <button class="button" onclick="closeBestiary()">Close Bestiary</button>
  </div>

  <!-- Game Over Overlay -->
  <div id="gameOverOverlay" class="overlay">
    <h1>Game Over</h1>
    <p>Final EXP: <span id="finalExp">0</span></p>
    <button class="button" onclick="restartGame()">Restart Game</button>
  </div>
</div>

<script>
// Global game state
let debugMode = false;
let gameState = {
    playerHealth: 100,
    playerLives: 3,
    experience: 0,
    level: 1,
    nextLevelExp: 50,
    playerAttackDamage: 10,
    persistentCoins: Number(localStorage.getItem('persistentCoins')) || 0
};

function toggleDebug() {
    debugMode = !debugMode;
    let debugOverlay = document.getElementById('debugOverlay');
    debugOverlay.style.display = debugMode ? 'block' : 'none';
    
    // Toggle physics debug
    if (currentScene) {
        currentScene.physics.world.drawDebug = debugMode;
        currentScene.physics.world.debugGraphic.clear();
    }
}

function updateDebugOverlay() {
    if (!debugMode) return;
    
    let debugInfo = {
        FPS: Math.round(currentScene.game.loop.actualFps),
        Objects: {
            Enemies: enemies?.countActive() || 0,
            Projectiles: projectiles?.countActive() || 0,
            XP_Orbs: xpOrbs?.countActive() || 0,
            Coins: coins?.countActive() || 0
        },
        Player: {
            Position: `(${Math.round(player?.x || 0)}, ${Math.round(player?.y || 0)})`,
            Velocity: `(${Math.round(player?.body?.velocity?.x || 0)}, ${Math.round(player?.body?.velocity?.y || 0)})`
        },
        Memory: Math.round(performance.memory?.usedJSHeapSize / 1048576) + 'MB' // Convert to MB
    };
    
    document.getElementById('debugOverlay').innerHTML = 
        `<pre>${JSON.stringify(debugInfo, null, 2)}</pre>`;
}

// Optimized update functions
const updatePlayerMovement = (player, cursors, wasd, speed) => {
    let vx = 0, vy = 0;
    
    // Combine keyboard inputs
    if (cursors.left.isDown || wasd.A.isDown) vx -= 1;
    if (cursors.right.isDown || wasd.D.isDown) vx += 1;
    if (cursors.up.isDown || wasd.W.isDown) vy -= 1;
    if (cursors.down.isDown || wasd.S.isDown) vy += 1;
    
    // Normalize and apply speed
    if (vx !== 0 || vy !== 0) {
        const norm = Math.sqrt(vx * vx + vy * vy);
        vx = (vx / norm) * speed;
        vy = (vy / norm) * speed;
    }
    
    player.setVelocity(vx, vy);
};

const updateProjectiles = (time, projectiles, lifetime) => {
    projectiles.children.each(proj => {
        if (time - proj.creationTime > lifetime || proj.body.speed < 1) {
            if (proj.onDestroy) proj.onDestroy(proj);
            proj.destroy();
        }
    });
};

const updateCollectibles = (player, items, suckRange, onCollect) => {
    items.children.each(item => {
        const dx = player.x - item.x;
        const dy = player.y - item.y;
        const distSq = dx * dx + dy * dy;
        
        if (distSq < 100) { // 10^2 for collection radius
            onCollect(player, item);
        } else if (distSq < suckRange * suckRange) {
            const dist = Math.sqrt(distSq) || 1;
            const speed = item.suckSpeed || 30;
            item.setVelocity((dx/dist) * speed, (dy/dist) * speed);
        } else {
            item.setVelocity(0, 0);
        }
    });
};

function enemyHitPlayer(playerObj, enemy) {
    // Apply damage to player
    player.health -= 20;
    
    // Visual feedback
    showHitIndicator();
    spawnEffectPhaser.call(currentScene, player.x, player.y, 'enemy');
    
    // Check for death
    if (player.health <= 0) {
        player.lives -= 1;
        if (player.lives > 0) {
            // Respawn with full health
            player.health = gameState.playerHealth;
            // Grant brief invulnerability
            player.invulnerable = true;
            setTimeout(() => { player.invulnerable = false; }, 2000);
        } else {
            // Game Over
            gamePaused = true;
            document.getElementById('finalExp').innerText = experience;
            document.getElementById('gameOverOverlay').style.display = 'block';
        }
    }
    
    // Knockback effect
    let angle = Math.atan2(player.y - enemy.y, player.x - enemy.x);
    player.setVelocity(Math.cos(angle) * 300, Math.sin(angle) * 300);
}
